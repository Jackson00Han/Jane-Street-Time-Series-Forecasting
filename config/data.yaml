# =========================
# Jane Street 项目全局配置
# =========================


# 版本与根
exp_root: "exp/v1"          # 切版本只改这里

# --------- 随机与可复现 ---------
seed: 42


# -----------------------------
# I/O 配置
# -----------------------------
io:
  backend: azure        # local | azure   ← 在这里切换

# 云端配置（Azure Blob Storage）
blob:
  container: "jackson"
  prefix: "js_exp"          # 云端容器内的项目前缀

local:
  root: "/mnt/data/js"      # 本地数据根目录

# 目录
paths:
  raw_root:          "raw" # 在blob/container/prefix内的相对路径

  # 相对 exp_root 的相对路径
  raw_shards:   "raw_shards"
  clean_shards: "clean_shards"          # 清洗后分片，供特征工程
  fe_shards:    "fe_shards"             # 特征分片
  sample_fe:    "sample_fe"             # 采样后的特征（可选）
  panel_shards: "panel_shards"          # 面板化分片

  mm:           "mm"                    # 全量内存映射 （本地）
  mm_shards:    "mm_shards"             # 分片内存映射（本地）
  sample_mm:    "sample_mm"             # 采样内存映射（本地）
  panel_mm:     "panel_mm"              # 面板内存映射（本地）

  models:       "models"
  reports:      "reports"
  cache:        "cache"
  tmp:          "tmp"

  feature_list_path: "/mnt/data/js/exp/v1/models/feature_set/fs__1020-1100__cv2-g3-r9__seed42__top632__1758034774.txt"            # 特征列表路径

# 关键列与目标
keys: ["symbol_id", "date_id", "time_id"]
target: "responder_6"
weight: "weight"
sorts:
  time_major: ["date_id", "time_id", "symbol_id"]

time_bucket: "time_bucket"           # 生成的时间桶列名（与 bucket_size 相关）


schema:                                  # 仅用于启动时的快速校验
  keys:
    symbol_id: int32
    date_id: int32
    time_id: int32
  target: float32
  weight: float32

# --------- 数据时间范围与切分 ---------
dates:
  date_lo: 1000
  date_hi: 1100
  train_lo: 1020
  train_hi: 1100
  feature_select_dates:
    date_lo: 1040
    date_hi: 1100


# --------- 交易时序参数（影响填充/窗口等） ---------
trading:
  ticks: 968 # 最大日tick数（从0-967）
  bucket_size: 6                         # 用于 time_bucket 的桶宽
  #open_auction_ticks: 5                  # 开盘集合竞价长度（用于跨日 TTL 生效窗口）
  #close_auction_ticks: 5                 # 收盘集合竞价长度（用于跨日 TTL 生效窗口）

# --------- 缺失值填充策略 ---------
fill:
  open_tick_window: [0, 10]          # 半开区间 [0,10)
  ttl_days_open: 7                 # 开盘跨日承接 TTL（天）
  intra_ffill_max_gap_ticks: 200     # 日内向前填补的最大跨度（tick）
  ttl_days_same_tick: 7           # 同一 time_id 跨日承接 TTL（天，None 关闭）
  order:
    - "open_ttl"                     # 步骤1
    - "intraday_ffill"               # 步骤2
    - "same_tick_ttl"                # 步骤3（可选）
    - "intraday_ffill"               # 步骤4（再传播
  batch_size: 30                     # 按日期分批保存（内存控制）


# --------- 极端值处理（Winsorize/截断） ---------
winsorization:
  method: "zscore"          # 这一步走 zscore
  groupby: ["symbol_id", "time_bucket"]    # 如发现强日内季节性可改为 ["symbol_id","time_id"]
  z_k: 3
  ddof: 1
  window: 480
  min_valid: 10
  cast_float32: true
  sanitize: true                     # 是否先将 inf/-inf 替换为 null


feature_eng:
  A:
    enabled: true
    is_sorted: false
    prev_soft_days: 7
    cast_f32: true
    # 适度的尾部滞后
    tail_lags: [1, 2, 4, 8, 16, 32, 64, 128, 256, 512, 967]
    tail_diffs: [1, 4, 16, 64]
    # 日度滚动：短中长三档
    rolling_windows: [3, 5, 7, 14]

  B:
    enabled: true
    is_sorted: false
    prev_soft_days: 7        # TTL 软天数，和 A 保持一致
    cast_f32: true
    ndays: 5                 # 同一 time_id 回看 5 天
    stats_rep_cols: null
    add_prev1_multirep: true
    batch_size: 5

  C:
    enabled: true
    is_sorted: false
    prev_soft_days: 7
    cast_f32: true
    batch_size: 10
    # 适度的历史派生
    lags: [1, 2, 4, 8, 16, 32, 64, 128, 256, 512, 967]
    ret_periods: [1, 4, 8, 16]
    diff_periods: [1, 2, 4, 8, 16]
    rz_windows: [3, 5, 7, 14]
    ewm_spans: [5, 10, 30, 60]
    keep_rmean_rstd: true
    cs_cols: []              # 若后续要做截面rank，再指定列名

  fe_pad_days: 30
  fe_core_days: 30

cv:
  n_splits: 2
  gap_days: 3
  train_to_val: 9


lgb_select:
  device_type: gpu        # 或 cpu
  learning_rate: 0.05
  num_leaves: 63
  max_depth: 8
  feature_fraction: 0.80
  bagging_fraction: 0.80
  bagging_freq: 1
  min_data_in_leaf: 200
  num_boost_round: 4000
  early_stopping_rounds: 100
  log_period: 100
  select_top_k: 600       # 导出前K特征

lgb_train:
  device_type: gpu        # 或 cpu
  learning_rate: 0.05
  num_leaves: 63
  max_depth: 8
  feature_fraction: 0.80
  bagging_fraction: 0.80
  bagging_freq: 1
  min_data_in_leaf: 200
  num_boost_round: 4000
  early_stopping_rounds: 100
  log_period: 100
  final_boost_margin: 1.10

# --------- 列级白名单（强约束，防止隐形泄露） ---------
white_list: ["time_pos", "time_sin", "time_cos", "time_bucket"]


debug:
  check_time_monotone: true   # 开发期开；批量/生产可关

  


# --------- 报告与审计 ---------