# =========================
# Jane Street 项目全局配置
# =========================

# 版本与根
exp_root: "exp/v1"          # 切版本只改这里

blob:
  container: "jackson"
  prefix: "js_exp"          # 云端容器内的项目前缀

local:
  root: "/mnt/data/js"      # 本地数据根目录

# 目录（除了raw, 其他均为相对 exp_root 的相对路径；实际使用：P(kind, cfg.exp_root, cfg.paths.clean)）
paths:
  raw:          "raw" # 在blob/container/prefix内的相对路径


  raw_shards:   "raw_shards"
  clean:        "clean"
  clean_shards: "clean_shards"          # 清洗后分片，供特征工程
  fe_shards:    "fe_shards"             # 特征分片
  sample_fe:    "sample_fe"             # 采样后的特征（可选）
  panel_shards: "panel_shards"          # 面板化分片
  mm:           "mm"                    # 全量内存映射
  mm_shards:    "mm_shards"             # 分片内存映射（可选）
  sample_mm:    "sample_mm"             # 采样内存映射（本地）
  panel_mm:     "panel_mm"              # 面板内存映射（本地）
  models:       "models"
  reports:      "reports"
  cache:        "cache"
  tmp:          "tmp"

io:
  use_simplecache: true                 # 读云端小文件建议启用：simplecache::az://...
  max_workers: 8                        # 并发上限（上层控制）
  # cache_dir 默认复用 paths.cache

# 关键列与目标
keys: ["symbol_id", "date_id", "time_id"]
target: "responder_6"
weight: "weight"

schema:                                  # 仅用于启动时的快速校验
  keys:
    symbol_id: int32
    date_id: int32
    time_id: int32
  target: float32
  weight: float32

# --------- 数据时间范围与切分 ---------
dates:
  date_lo: 1190
  date_hi: 1429
  valid_start_at: 1400                   # 验证集起始（含）
  test_start_at: 1410                    # 测试集起始（含）
  embargo_days: 5                        # 训练/验证/测试间的禁运天数（防泄露）

# --------- 交易时序参数（影响填充/窗口等） ---------
trading:
  ticks: 968
  open_auction_ticks: 5                  # 开盘集合竞价长度（用于跨日 TTL 生效窗口）
  close_auction_ticks: 5
  bucket_size: 6                         # 用于 time_bucket_{K}

# --------- 缺失值填充策略 ---------
fill:
  ttl_ticks: 3                           # 跨日承接的“存活上限”tick 数（仅开盘短窗内生效）
  ffill_max_span: 64                     # 日内向前填充的最大跨度；超出仍视为缺失
  order: ["crossday_ttl_then_intraday_ffill"]   # 固定顺序：先跨日TTL，后日内ffill

# --------- 极端值处理（Winsorize/截断） ---------
winsorization:
  method: "zscore"                       # "zscore" | "quantile"
  z_k: 3
  q_low: 0.005
  q_high: 0.995
  groupby: ["symbol_id"]                 # 如存在强季节性，可改 ["symbol_id","time_id"]
  min_warmup_days: 20                    # 扩张窗口的热身天数
  clip_exclude: ["responder_6", "weight"]# 禁止截断的列

# --------- 列级白名单（强约束，防止隐形泄露） ---------
column_policies:
  allow_crossday: []                     # 允许跨日TTL承接（谨慎添加，避免价量/盘口/回报）
  intra_ffill_only: []                   # 仅允许“日内向前填充”的列（大部分价量盘口列放这里）
  no_fill: []                            # 任何场景都不填（停牌/熔断/事件标志等）
  time_features:                         # 仅示例；生成时按 bucket_size 同步命名
    - "time_pos"
    - "time_sin"
    - "time_cos"
    - "time_bucket_6"                    # 若 bucket_size 改为K，列名需改为 time_bucket_K
    - "is_open_auction"
    - "is_close_auction"

# --------- 断言（启动即校验，早失败） ---------
assertions:
  unique_key: true                       # (symbol_id, date_id, time_id) 唯一
  time_monotonic: true                   # 组内时间非降
  no_future_joins: true                  # 禁止 asof 到未来
  split_bounds:
    require: true
    rules:
      - "date_lo <= valid_start_at <= date_hi"
      - "valid_start_at < test_start_at <= date_hi"
      - "min_warmup_days <= (valid_start_at - date_lo)"

# --------- 随机与可复现 ---------
repro:
  seed: 42
  deterministic_ops: true

# --------- 报告与审计 ---------
reports:
  subdirs: ["metrics", "audits", "logs", "snapshots"]
  write_path_snapshot: true              # 记录本次运行的路径快照（含 exp_root）
